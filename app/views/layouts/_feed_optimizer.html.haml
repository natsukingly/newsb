
#feed_optimizer


  =form_tag '/optimized_index', method: :get, remote: true do
    =submit_tag "OPTIMIZE", class: "save_btn"
    =text_field_tag :personalized_tags, "", placeholder: "add more tags", id: :personalized_tag_form, :autocomplete => "off"
    #autocomplete_personalized_tags
    #personalized_tags.tag_block
      =render '/layouts/personalized_tag_block', personalized_tags: @personalized_tags
    %h2
      %i.fa.fa-folder-open
      Categories
    .category_tags.tag_block  
      -default_category_tags.each do |tag|
        =label_tag do
          .tag_pill
            - if cookies[:search_preference]
              - if JSON.parse(cookies[:search_preference]).include?((tag.id).to_s)
                =check_box_tag "tag_ids[]", tag.id, true, style: "display: none;"
              - else
                =check_box_tag "tag_ids[]", tag.id, false, style: "display: none;"
            - else
              =check_box_tag "tag_ids[]", tag.id, false, style: "display: none;"
            .tag_content.give_me_short_ellipsis
              = tag.name
    %h2
      %i.fa.fa-globe
      Regions
    
    .rigion_tags.tag_block 
      -default_region_tags.each do |tag|
        =label_tag do
          .tag_pill
            - if cookies[:search_preference]
              - if JSON.parse(cookies[:search_preference]).include?((tag.id).to_s)
                =check_box_tag "tag_ids[]", tag.id, true, style: "display: none;"
              - else
                =check_box_tag "tag_ids[]", tag.id, false, style: "display: none;"
            - else
              =check_box_tag "tag_ids[]", tag.id, false, style: "display: none;"
              
            .tag_content.give_me_short_ellipsis
              = tag.name
              
              
:javascript

  // for autocomplete 
  var $text_area = $('#personalized_tag_form'); 
  
  // disabling default enter & up key function of keyboard 
  $text_area.keydown(function(e) {
    if(e.keyCode === 13 || e.keyCode === 38 || e.keyCode === 40){
  	  if($('#autocomplete_personalized_tags a').length){
  	    return false;
  	  }
  	}

  });
  
  // selecting tags through autocomplete_tag_lists
  $text_area.keyup(function(e) {
  
    var $selected_tag = $('#suggested_personalized_tags').find('.selected');
    var last_index = $('#suggested_personalized_tags a').length - 1;
    var selected_index = $selected_tag.index();
    
    // up
  	if(e.keyCode === 38) {
  	    $selected_tag.removeClass("selected");
  	    if(selected_index == 0){
  	    

  	      selected_index = last_index
  	      $('#suggested_personalized_tags a').eq(selected_index).addClass("selected");
  	      
  	     

  	      return false;
  	    } else{
          selected_index = selected_index - 1;
          $('#suggested_personalized_tags a').eq(selected_index).addClass("selected");
          

          return false;
    	  }
    // down
  	} else if(e.keyCode === 40){
  	    $selected_tag.removeClass("selected");
  	    if(selected_index == last_index){
  	      selected_index = 0;
  	      $('#suggested_personalized_tags a').eq(selected_index).addClass("selected");
  	      
  	      return false;
  	    } else{
    	    selected_index = selected_index + 1;
    	    $('#suggested_personalized_tags a').eq(selected_index).addClass("selected");
    	    

    	    return false;
    	  }
    // enter
  	} else if(e.keyCode === 13){
  	    $selected_tag.trigger("click");
  	    return false;
  	}
  	
  	
  // customized for feed optimizer. no need for # letter.	
  // 	collecting suggested tags through ajax
    var input = $text_area.val();

    if( input.length > 1){
      $.ajax({
        url: "/posts/autocomplete_personalized_tags",
        type: "GET",
        data: {input : input},
        dataType: 'script',
      });
      return false;
    }
    $('#autocomplete_personalized_tags').html(" ");
  	return false;
  });